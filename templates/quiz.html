<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Вопросы</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/static/style.css" rel="stylesheet"/>
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="card shadow">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Вопрос <span id="current">1</span> из {{.Total}}</span>
      <span id="timer">00:00</span>
    </div>
    <div class="card-body">
      <form id="quizForm">
        <div id="question-container">
          <!-- Вопрос и варианты будут вставлены JS -->
        </div>

        <div class="d-flex justify-content-between mt-4 flex-wrap gap-2">
          <button type="button" id="prevBtn" class="btn btn-secondary" disabled>Предыдущий вопрос</button>
          <button type="button" id="finishBtn" class="btn btn-success d-none">Завершить тест</button>
          <button type="button" id="nextBtn" class="btn btn-primary">Следующий вопрос</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const questions = {{.Questions | json}};
const total = {{.Total}};
let current = 0;
let answers = new Array(total).fill(0);
let startTime = Date.now();

function renderQuestion() {
  const q = questions[current];
  const cont = document.getElementById('question-container');
  cont.innerHTML = `
    <h5 class="mb-4">${escapeHtml(q.text)}</h5>
    <div class="mt-3">
      ${q.options.map((opt, i) => `
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="answer" value="${i+1}" id="opt${i}" ${answers[current] === i+1 ? 'checked' : ''}>
          <label class="form-check-label" for="opt${i}">${escapeHtml(opt)}</label>
        </div>
      `).join('')}
    </div>
  `;

  document.getElementById('current').textContent = current + 1;

  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const finishBtn = document.getElementById('finishBtn');

  // Управление кнопками
  prevBtn.disabled = current === 0;
  if (current === 0) {
    prevBtn.classList.add('d-none');
    nextBtn.classList.remove('d-none');
    finishBtn.classList.add('d-none');
  } else if (current === total - 1) {
    prevBtn.classList.remove('d-none');
    nextBtn.classList.add('d-none');
    finishBtn.classList.remove('d-none');
  } else {
    prevBtn.classList.remove('d-none');
    nextBtn.classList.remove('d-none');
    finishBtn.classList.add('d-none');
  }

  // Сохраняем ответ
  cont.querySelectorAll('input[name="answer"]').forEach(input => {
    input.onchange = () => {
      answers[current] = parseInt(input.value);
    };
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Навигация
document.getElementById('prevBtn').onclick = () => {
  if (current > 0) {
    current--;
    renderQuestion();
  }
};

document.getElementById('nextBtn').onclick = () => {
  if (current < total - 1) {
    current++;
    renderQuestion();
  }
};

document.getElementById('finishBtn').onclick = () => {
  submitQuiz();
};

// Отправка
function submitQuiz() {
  const formData = new FormData();
  answers.forEach((ans, i) => {
    if (ans > 0) formData.append(`q${i}`, ans);
  });

  fetch('/submit', {
    method: 'POST',
    body: formData
  }).then(r => r.text()).then(html => {
    document.open();
    document.write(html);
    document.close();
  }).catch(err => {
    alert('Ошибка отправки: ' + err);
  });
}

// Таймер
setInterval(() => {
  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
  const s = String(elapsed % 60).padStart(2, '0');
  document.getElementById('timer').textContent = `${m}:${s}`;
}, 1000);

// Инициализация
renderQuestion();
</script>
</body>
</html>
